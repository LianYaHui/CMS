<div style="height:100%; overflow:auto;">
    <table cellpadding="0" cellspacing="0" class="tblist" id="tbGpsDev"></table>
</div>
<script type="text/javascript">
var gpstrack = gpstrack || {};

gpstrack.map;
gpstrack.lat_center = 30.61981616418195;
gpstrack.lng_center = 114.25053151825193;
gpstrack.latlng_center;
gpstrack.info_window = null;
gpstrack.cur_marker = null;
gpstrack.zoom = 14;
gpstrack.marker_id = 1;
gpstrack.flightPath = null;
gpstrack.linePath = [];
gpstrack.markers = [];
gpstrack.tracks = [];

gpstrack.distance_line = null;

gpstrack.pageStart = 1;
gpstrack.pageIndex = gpstrack.pageStart;
gpstrack.pageSize = 20;


gpstrack.playid = null;
gpstrack.playnum = 0;
gpstrack.playcount = 0;

gpstrack.speeds = [2000,1000,500,250,125];
gpstrack.isplay = false;
gpstrack.playspeed = gpstrack.speeds[2];

gpstrack.drawline = false;
gpstrack.linestyle = {color:'#f00', width:1};
gpstrack.lastmarker = null;
gpstrack.gpsline = [];

gpstrack.mapmove = true;

var gpsDevList = [
    ['92621', '武南网工区-92621', 4, 1],
    ['92630', '武南网工区激光摄像头-92630', 1],
    ['92623', '武东网工区-92623', 4],
    ['92624', '武东网工区激光摄像头92624', 1],
    ['92625', '汉川网工区-92625', 4],
    ['92626', '汉川网工区激光摄像头92626', 1],
    ['92627', '咸宁北网工区-92627', 4],
    ['92628', '咸宁北网工区激光摄像头92628', 1],
    ['92629', '麻城北网工区-92629', 4],
    ['92622', '麻城北网工区激光摄像头92622', 1, 1],
    ['92631', '武汉北网工区-92631', 4],
    ['92632', '武汉北网工区激光摄像头92632', 1],
    ['92633', '麻城网工区-92633', 4],
    ['92634', '麻城网工区激光摄像头92634', 1],
    ['92635', '蕲春网工区-92635', 4],
    ['92636', '蕲春网工区激光摄像头92636', 1],
    ['100003025', '手提箱-100003025', 1],
    ['100003027', '手提箱-100003027', 1]
];

function iniGpsDev(){
    var objList = cms.util.$('tbGpsDev');

    cms.util.clearDataRow(objList, 0);
    
    var rid = 0;
    var rowData = [];
    
    for(var i=0; i<previewDevList.length; i++){
        var dr = previewDevList[i];
        var row = objList.insertRow(rid);
        var cellid = 0;
        
        row.lang = '{devCode:' + dr[0] + ',name:\'' + dr[1] + '\',channel:\'' + dr[2] + '\'}';
        /*
        row.ondblclick = function(){
            var lang = eval('(' + this.lang + ')');
            if(lang.lat == ''){
                showDevGpsList(lang.devCode);
            } else {
                showDevGpsList(lang.devCode);
            }
        };
        */
        
        var strName = '<a onclick="gpstrack.showDevGpsList(\'' + dr[0] + '\',\'' + dr[1] + '\');">' + dr[1] + '</a>';
        var cc = parseInt(dr[2], 10);
        var strGps = '<a onclick="gpstrack.showDevGpsList(\'' + dr[0] + '\',\'' + dr[1] + '\');">' + 'GPS轨迹' + '</a>';
                
        rowData[cellid++] = {html: (rid + 1), style:[['width','20px']]};
        rowData[cellid++] = {html: strName, style:[['width','150px']]};
        rowData[cellid++] = {html: strGps, style:[['width','60px']]};
        rowData[cellid++] = {html: '', style:[]};
            
        cms.util.fillTable(row, rowData);
        rid++;
    }
}

gpstrack.setPlaySpeed = function(obj, num, speed){
    for(var i=1; i<=gpstrack.speeds.length; i++){
        cms.util.$("sp" + i).style.background = "#ff0";
    }
    obj.style.background = "#f00";
    gpstrack.playspeed = speed;
};

gpstrack.play = function(){
    gpstrack.showTrack();
};

gpstrack.stop = function(){
    gpstrack.isplay = false;
    //ZyrhGpsTrack.SetDrawTrackLineDisabled(false);
    gpstrack.stopPlay(gpstrack.playid);
    $('#chbTrackLine').attr('disabled', false);
};

gpstrack.stopPlay = function(id){
    if(id != null) clearInterval(id);
};

gpstrack.clearTrack = function(){
    if(!gpstrack.isplay){
        for(var i=0,c=gpstrack.tracks.length; i<c; i++){
            gpstrack.clearMarker(emap.map, gpstrack.tracks[i]);
        }
        for(var i=0,c=gpstrack.gpsline.length; i<c; i++){
            gpstrack.gpsline[i].setMap(null);
        }
    }
};

gpstrack.createMarker = function(map, latlng, id){
    var marker = new google.maps.Marker({
        position: latlng,
        map: emap.map,
        title: ''//ZyrhGpsTrack.BuildTitle(id)
    }); 
        
    return marker;
}

gpstrack.createTrack = function(map, latlng, id, img){
    var marker = new google.maps.Marker({
        position: latlng,
        map: emap.map,
        icon: img,
        title: ''//ZyrhGpsTrack.BuildTitle(id)
    }); 
        
    return marker;
}

gpstrack.clearMarker = function(map, marker){
    if(marker != null){
        marker.setMap(null);
    }
    if(gpstrack.markers.length > 0){
        for(var i=0; i<gpstrack.markers.length; i++){
            gpstrack.markers[i].setMap(null);
        }
    }
}


gpstrack.setDrawTrackLineDisabled = function(disabled){
    if(disabled){
        $('#chbTrackLine').attr('disabled', 'disabled');    
    }
    else{
        $('#chbTrackLine').removeAttr('disabled');
    }
    if(gpstrack.drawline && !gpstrack.isplay){
        $('#ddlLineColor').removeAttr('disabled');
        $('#ddlLineSize').removeAttr('disabled');    
    }
    else{
        $('#ddlLineColor').attr('disabled','disabled');
        $('#ddlLineSize').attr('disabled','disabled');     
    }
}

gpstrack.setDrawTrackLine = function(obj){
    if(obj.checked){
        gpstrack.drawline = true;
        $('#ddlLineColor').removeAttr('disabled');
        $('#ddlLineSize').removeAttr('disabled');
    }
    else{
        gpstrack.drawline = false;
        $('#ddlLineColor').attr('disabled','disabled');
        $('#ddlLineSize').attr('disabled','disabled');    
    }
}

gpstrack.setMapMove = function(move){
    gpstrack.mapmove = move;
}

gpstrack.setLineColor = function(color){
    gpstrack.linestyle.color = color;
    $('#divLineColor').css('background',color);
}

gpstrack.setMapZoom = function(z){
    //gpstrack.zoom = parseInt(z, 10);
    emap.zoom = parseInt(z, 10);
    emap.map.setZoom(emap.zoom);
}

gpstrack.setMapCenter = function(latLng){
    emap.map.setCenter(latLng);
}

gpstrack.showDevGpsList = function(devCode, devName){
    var strSpeed = '';
    for(var i=0; i<gpstrack.speeds.length; i++){
        strSpeed += '<td id="sp' + (i+1) + '" onclick="gpstrack.setPlaySpeed(this,'+ (i+1) + ',' + gpstrack.speeds[i] + ');" '
            + ' style="width:17px; cursor:pointer; '
            + ' background:' + (gpstrack.playspeed == gpstrack.speeds[i] ? '#f00':'#ff0')+ ';"></td>';
    }
        
    var strHtml = '<input type="hidden" id="txtDevIndexCode_Gps" value="' + devCode + '" />'
        + '<div style="padding:5px;border-bottom:solid 1px #99bbe8;background:#dbebfe;">'
        + '开始时间:<input type="text" id="txtDevGpsStartTime" class="txt w115" value="' + new Date().toString('yyyy-MM-dd') + ' 0:00:00" />'
        + '&nbsp;结束时间:<input type="text" id="txtDevGpsEndTime" class="txt w115" value="' + new Date().toString('yyyy-MM-dd') + ' 23:59:59" />'
        + '&nbsp;<a class="btn btnc22" onclick="gpstrack.getDevGpsList();"><span>查询</span></a>'
        + '</div>'
        + '<div style="padding:5px;border-bottom:solid 1px #99bbe8;overflow:hidden;clear:both;background:#dbebfe;">'
                
        + '<div style="padding:0; display:block; clear:both;" id="setTrackLine">'
        + '<label style="float:left;margin-top:3px;">'
        + '<input type="checkbox" id="chbTrackLine" style="float:left;"' + (gpstrack.drawline ? ' checked="checked" ' : '') + (gpstrack.isplay ? ' disabled="disabled"' : '') + ' onfocus="this.blur();" onclick="gpstrack.setDrawTrackLine(this);" />轨迹连线'
        + '</label>'
        + '<div style="background:' + gpstrack.linestyle.color + ';width:11px; height:22px; float:left; display:block;margin:0 0 0 12px;" id="divLineColor"></div>'
        + '<select id="ddlLineColor" class="select" style="width:62px;float:left;margin-left:2px;" title="线条颜色" ' + (gpstrack.drawline && !gpstrack.isplay ? '' : 'disabled="disabled"') + ' onchange="gpstrack.setLineColor(this.value);">'
        + cms.util.buildOptions([['#f00','红色'],['#00f','蓝色'],['#008000','绿色'],['#f0f','紫红色'],['#000','黑色'],['#ff0','黄色'],['#fff','白色']], gpstrack.linestyle.color)
        + '</select>'
        + '<select id="ddlLineSize" class="select" style="width:50px;float:left;margin-left:3px;" title="线条宽度" ' + (gpstrack.drawline && !gpstrack.isplay ? '' : 'disabled="disabled"') + ' onchange="linestyle.width = this.value">'
        + cms.util.buildOptions([['1','1px'],['2','2px'],['3','3px'],['4','4px'],['5','5px']], gpstrack.linestyle.width)
        + '</select>'
        
        + '<table style="margin-left:13px; height:14px; line-height:14px;float:left;" cellpadding="0" cellspacing="3" border="0">'
        + '<tr>'
        + '<td style="padding-top:3px;">速度: 慢</td>'
        + strSpeed
        + '<td style="padding-top:3px;">快</td>'
        + '</tr></table>'
        
        + '</div>'
        + '<div style="padding:5px 5px 5px 0; display:block; clear:both;">'
        + '<div style="float:left;">'
        + '<label style="float:left;margin-top:3px;">'
        + '<input type="checkbox" checked="checked" id="chbMapMove" style="float:left;"' + (gpstrack.mapmove ? ' checked="checked" ' : '') + ' onfocus="this.blur();" onclick="gpstrack.setMapMove(this.checked);" />地图跟随移动'
        + '</label>'
        + '<span style="float:left;margin:3px 1px 0 17px">地图缩放</span>'
        + '<select id="dllMapZoom" class="select" style="width:50px;" onchange="gpstrack.setMapZoom(this.value);">'        
        + cms.util.buildOptions([['20','20'],['19','19'],['18','18'],['17','17'],['16','16'],['15','15'],['14','14'],['13','13'],['12','12'],['11','11'],['10','10'],['9','9'],['8','8'],['7','7'],['6','6'],['5','5']], emap.zoom)
        + '</select>'
        + '</div>'
        + '<div style="float:left; margin-left:15px;">'
        + '<a class="btn btnc22" onclick="gpstrack.play();"><span class="w30">播放</span></a>&nbsp;'
        + '<a class="btn btnc22" onclick="gpstrack.stop();"><span class="w30">停止</span></a>&nbsp;'
        + '<a class="btn btnc22" onclick="gpstrack.clearTrack();"><span class="w60">清除轨迹</span></a>'
        + '</div>'
        
        + '</div>'
        + '</div>'
        
        + '<div style="height:253px;overflow:auto;clear:both;">'
        + '<div class="listheader">'
        + '<table cellpadding="0" cellspacing="0" class="tbheader">'
        + '<tr>'
        + '<td style="width:35px;">序号</td>'
        + '<td style="width:75px;">纬度</td>'
        + '<td style="width:75px;">经度</td>'
        + '<td style="width:55px;">速度</td>'
        + '<td style="width:120px;">接收时间</td>'
        + '<td></td>'        
        + '</tr>'
        + '</table>'
        + '</div>'
        + '<div style="height:228px;overflow:auto;"><table class="tblist" id="tbDevGpsList"></table></div>'
        + '</div>'
        + '<div style="height:25px; padding-top:1px; background:#dbebfe;border-top:solid 1px #99bbe8;"><span id="lblGpsPagination"></span></div>'
        + '</div>';
    var config = {
        id: 'pwGpsBox',
        title: 'GPS轨迹 - ' + devName,
        html: strHtml,
        width: 420,
        height: 400,
//        boxType: 'iframe',
//        requestType: 'iframe',
        noBottom: true,
        minAble: true,
        showMinMax: true,
        minHeight: 120,
        minWidth: 420,
        lock: false
    };
    
    cms.box.win(config);
    
    var maxdate = '2013-12-31 0:00:00';
    $("#txtDevGpsStartTime").focus(function(){
        WdatePicker({skin:'ext',minDate:'2012-09-01 0:00:00',maxDate:maxdate,dateFmt:'yyyy-MM-dd HH:mm:ss'});
    });
    $("#txtDevGpsEndTime").focus(function(){
        WdatePicker({skin:'ext',minDate:'2012-09-01 0:00:00',maxDate:maxdate,dateFmt:'yyyy-MM-dd HH:mm:ss'});
    });
}

gpstrack.getDevGpsList = function(){
    var devIndexCode = $("#txtDevIndexCode_Gps").val();   
    var startTime = $("#txtDevGpsStartTime").val();
    var endtime = $("#txtDevGpsEndTime").val();
    if(devIndexCode == ''|| startTime == ''|| endtime == ''){
        alert('请选择时间');
        return false;
    }
    var urlparam = cms.util.path + '/ajax/gpstrack.aspx?action=getDevGpsList&devCode=' + devIndexCode
        + '&startTime=' + startTime + '&endtime=' + endtime + '&pageIndex=' + (gpstrack.pageIndex - gpstrack.pageStart)
        + '&pageSize=' + gpstrack.pageSize + '&' + Date();
    //alert(urlparam);
    $.ajax({ 
        type: "post", 
        //async:false,
        datatype: "json",
        url: urlparam, 
        error: function(data){
            alert('e:' + data);
        },
        success: function(data){
            if(data != ''){
                var jsondata = eval('(' + data + ')');
                if(jsondata.list.length == 0){
                    $("#lblGpsPagination").html('没有相关的GPS轨迹记录');
                }
                else{
                    gpstrack.showDevGpsLogList(jsondata);
                }
            }
            else{
                $("#lblGpsPagination").html('没有相关的GPS轨迹记录');        
            }
        }
    });
};

gpstrack.showDevGpsLogList = function(jsondata){
    var objList = cms.util.$('tbDevGpsList');
    var rid = 0;
    var rowData = [];
    var dataCount = jsondata.dataCount;
    
    cms.util.clearDataRow(objList, 0);
    
    for(var i=0; i<jsondata.list.length; i++){
        var dr = jsondata.list[i];
        var row = objList.insertRow(rid);
        var cellid = 0;
        var rnum = (gpstrack.pageIndex - gpstrack.pageStart) * gpstrack.pageSize + rid + 1;
        
        rowData[cellid++] = {html: rnum, style:[['width','35px']]};
        rowData[cellid++] = {html: dr.lat, style:[['width','75px']]};
        rowData[cellid++] = {html: dr.lng, style:[['width','75px']]};
        rowData[cellid++] = {html: dr.speed, style:[['width','55px']]};
        rowData[cellid++] = {html: dr.time, style:[['width','120px']]};
        rowData[cellid++] = {html: '', style:[]};
            
        cms.util.fillTable(row, rowData);
        rid++;
    }
        
    var config = {
        dataCount: dataCount,
        pageIndex: gpstrack.pageIndex,
        pageSize: gpstrack.pageSize,
        pageStart: gpstrack.pageStart,
        showType: 'nolist',
        markType: 'Symbol',
        callBack: 'gpstrack.showPage',
        showDataStat: false,
        showPageCount: false,
        showDataCount: true,
        keyAble: true
    };
    var pager = new Pagination();
    pager.Show(config, cms.util.$('lblGpsPagination'));
    pageCount = pager.pageCount;
};


gpstrack.showPage = function(page){
    gpstrack.pageIndex = parseInt(page, 10);
    gpstrack.getDevGpsList();
}

//显示轨迹
gpstrack.showTrack = function(){
    var devIndexCode = $("#txtDevIndexCode_Gps").val();
    var startTime = $("#txtDevGpsStartTime").val();
    var endtime = $("#txtDevGpsEndTime").val();
    
    if(devIndexCode == ''|| startTime == ''|| endtime == ''){
        alert('请选择时间');
        return false;
    }
    /*
    var urlparam = cms.util.path + '/ajax/gps.aspx?action=getDeviceGpsTrack&devCode=' + devIndexCode 
        + '&startTime=' + startTime + '&endtime=' + endtime + '&' + Date();
    */
    var urlparam = cms.util.path + '/ajax/gpstrack.aspx?action=getDevGpsTrack&devCode=' + devIndexCode
        + '&startTime=' + startTime + '&endtime=' + endtime + '&' + Date();
    //alert(urlparam);
    $.ajax({ 
        type: "post", 
        //async:false,
        datatype: "json",
        url: urlparam, 
        error: function(data){
            alert('e:' + data);
        },
        success: function(data){
            if(data != ''){
                var jsondata = eval('(' + data + ')');
                if(jsondata.gps.length == 0){
                    $("#lblGpsPagination").html('');
                }
                else{
                    if(jsondata.gps.length > 0){
                        gpstrack.setMapCenter(gpstrack.getLatLng(jsondata.gps[0][1],jsondata.gps[0][2]));
                    }
                    
                    gpstrack.playnum = 0;
                    gpstrack.playcount = jsondata.gps.length;
                    gpstrack.clearTrack();
                    if(gpstrack.playcount > 0){
                        gpstrack.isplay = true;
                        gpstrack.playid = window.setInterval(gpstrack.trackPlay, gpstrack.playspeed, jsondata.gps);
                        gpstrack.setDrawTrackLineDisabled(true);
                    }
                }
            }
            else{
                $("#lblGpsPagination").html('');
            }
        }
    });
}

gpstrack.getLatLng = function(lat, lng){
    return new google.maps.LatLng(lat, lng);
}

//轨迹回放
gpstrack.trackPlay = function(track){
    var latlng;
    var msg = '';
    if(gpstrack.playnum >= 0 && gpstrack.playnum <= gpstrack.playcount-1){
        if(gpstrack.playnum > 0){
            gpstrack.clearMarker(emap.map, gpstrack.tracks[gpstrack.playnum-1]);
            latlng = gpstrack.getLatLng(track[gpstrack.playnum-1][1],track[gpstrack.playnum-1][2]);
            var marker = gpstrack.createTrack(emap.map, latlng, gpstrack.playnum-1, 'http://wh.3gvs.net:82/static/imgs/gmap/point.png');
             
            //msg = BuildPrompt(gpstrack.playnum, track[gpstrack.playnum-1]);
            google.maps.event.addListener(marker, 'click', function(){
                //ZyrhGpsTrack.OpenMessage(map, marker, gpstrack.playnum, msg);
            });
            
            gpstrack.tracks[gpstrack.playnum-1] = marker;
        }
        
        latlng = gpstrack.getLatLng(track[gpstrack.playnum][1], track[gpstrack.playnum][2]);
        var marker1 = gpstrack.createTrack(emap.map, latlng, gpstrack.playnum);
         
        gpstrack.tracks[gpstrack.playnum] = marker1;
        
        if(gpstrack.playnum == gpstrack.playcount-1){
            //msg = BuildPrompt((gpstrack.playnum + 1), track[gpstrack.playnum]);
            google.maps.event.addListener(marker1, 'click', function(){
                //ZyrhGpsTrack.OpenMessage(emap.map, marker1, gpstrack.playnum, msg);
            });
        }
        //轨迹连线
        if(gpstrack.drawline){
            if(gpstrack.playnum > 0){
                var flightPlanCoordinates = [gpstrack.lastmarker, latlng];
                gpstrack.gpsline[gpstrack.playnum-1] = new google.maps.Polyline({
                    path: flightPlanCoordinates,
                    strokeColor: gpstrack.linestyle.color,
                    strokeOpacity: 0.99,
                    strokeWeight: gpstrack.linestyle.width
                });
                gpstrack.gpsline[gpstrack.playnum-1].setMap(emap.map);                
            }
            gpstrack.lastmarker = latlng;
        }
        if(gpstrack.mapmove){
            gpstrack.calculateToView(latlng);
        }
    }
    else{
        gpstrack.stopPlay(gpstrack.playid)
        gpstrack.isplay = false;
        //轨迹播放完成，允许设置是否连线轨迹
        gpstrack.setDrawTrackLineDisabled(false);
        
        var strHtml = '<div style="padding:10px;">轨迹回放结束</div>';
        new PopWin({title:'提示',html:strHtml,width:200,height:150,boxType:'alert',noBottom:false});
        return false;
    }
    gpstrack.playnum++;
}

gpstrack.calculateToView = function(latlng){
    var bounds = emap.map.getBounds();
    //不在bounds之内则做相应的处理
    if (!bounds.contains(latlng)){
        /*
        var ne = bounds.getNorthEast();
        var sw = bounds.getSouthWest();
        var northEastX = ne.x;
        var northEastY = ne.y;
        var southWestX = sw.x;
        var southWestY = sw.y;
        var center = map.getCenter();
        var lng = center.lng();
        var lat = center.lat();
        var px = latlng.lng();
        var py = latlng.lat();
        if (px <= southWestX){ //出左边界
            var minusRt = southWestX - px;
            center = new google.maps.LatLng(lat, lng - minusRt);
        } else if (px >= northEastX) { //出右边界
            var minusRt = px - northEastX;
            center = new google.maps.LatLng(lat, lng + minusRt);
        } else if (py >= northEastY) { //出上边界
            var minusRt = py - northEastY;
            center = new google.maps.LatLng(lat + minusRt, lng);
        } else if (py <= southWestY) { //出下边界
            var minusRt = southWestY - py;
            center = new google.maps.LatLng(lat - minusRt, lng);
        }
        map.panTo(center);
        */
        emap.map.setCenter(latlng);
    }
}
</script>